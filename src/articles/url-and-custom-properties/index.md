---
title: 'URL и кастомные свойства'
date: 2021-10-06
author: sergey-artemov
editors:
    - vadim-makeev
tags:
    - url
    - path
    - custom properties
    - bugs
    - browser engine
    - webkit
preview: 'Поучительная история исправления одного бага в браузерном движке.'
hero:
    src: images/cover.png
    cover: true
---

В [302 выпуске](https://web-standards.ru/podcast/302/) подкаста Веб-стандарты обсуждались огромные релизноуты Safari TP 133. Вот только их огромность [оказалисась ошибочной](https://bugs.webkit.org/show_bug.cgi?id=230243#c18):

> Релизноуты STP 133 неверны. Конечная версия для STP 133 некорректна. Список изменений включает множество записей, которые не являются частью поставленной сборки. Релизноуты будут обновлены с учетом правильного набора изменений и исправленного номера конечной версии.

Но больше интересно не это, а история одного из ошибочно попавших в эти релизноуты фиксе, который Никита Дубко озвучил так:

> Беда была в том, что CSS-переменные работали не так: если вы в css-переменную задаёте урл… резолвилось относительно html-документа. Оказывается это история связана с тем как работают CSS-переменные. В Safari починили… скорее так: поменяли это поведение и теперь css-переменные точно так же резолвятся относительно урла стилевой таблицы — вполне себе ожидаемая штука.

В действительности немного не так: всё-таки не «поменяли поведение», а исправили ошибку, починили. А ещё всё на много сложнее, чем кажется. Но начнём с начала.

## История фикса

Несколько месяцев назад я (не без помощи Руслана Берендеева) узнал, что в WebKit `url()` в кастомных свойствах резолвится не так, как ожидается, в отличие от Gecko и Blink. Нашёл уже давно заведённый [баг 200092](https://bugs.webkit.org/show_bug.cgi?id=200092). В нём была тишина и я не думал, что там возможно устроить движение. Оставил этот баг на несколько месяцев, пока в него не пришёл Вадим Макеев. И оказывается там отвечают 😮

Тогда я решил посмотреть, как теперь дела обстоят с этим багом, и с удивлением обнаружил, что в заброшенной ветке сломанные пути починились, но почему-то не везде. Разница в коде не большая, но существенная. Вдобавок оказалось, что надо учесть ещё одну особенность, шлейфом тянущуюся из уже пофикшенного на тот момент [бага 198512](https://bugs.webkit.org/show_bug.cgi?id=198512), из которого в мой «любимый баг» пришли Вадим и разработчик WebKit Дарин Адлер. Обе эти особенности кода обозначу ниже.

А пока важно то, что тогда для прояснения ситуации я решил собрать тест, максимально совпадающий с описанием из [заметки в спецификации](https://drafts.csswg.org/css-variables-1/#syntax), на которую сослался Дарин.

> Например, относительные URL-адреса в CSS сопоставляются с базовым URL-адресом таблицы стилей, в которой объявляется значение. Однако, если кастомное свойство, к примеру, `--my-image: url(foo.jpg); ` объявляется в таблице стилей `/a/style.css`, оно не будет немедленно преобразовано в абсолютный URL-адрес; если эта переменная позже будет использоваться, например `background: var(--my-image); `, в другой таблице стилей `/b/style.css`, то она преобразуется в путь `/b/foo.jpg`.

Добавил к описанному сценарию все возможные варианты, на основе тех особенностей. Снабдил тест описанием и таблицей результатов. И представил его в комментаниях к багу, надеясь, что это прояснит всю ситуацию.

Но вот незадача: оказалось, что я заметку понял как описание того, как должно работать, а Дарин — как браузерам **не** надо поступать (то, что Blink и Gecko ведут себя не по его прочтению заметки, он понимал). И до выяснения, как же всё-таки должны вести себя браузеры, он не хотел приниматься за код, что в общем-то правильно. Понимая, что со своим так-себе-инглишем могу не замечать какого-то нюанса, я стал просить помощи известных мне гуру спецификации. И таки помог «человек-спека» — Илья Стельцын. Он заметил, что вообще-то этот баг про регистрируемые кастомные свойства, которые:

> Передаются не как токены, а уже как обработанные значения.

Кажется это вывело из тупика, оживилось обсуждение, в результате которого, чтобы не менять этот, Дарин открыл новый [баг 230243](https://bugs.webkit.org/show_bug.cgi?id=230243), про взаимоотношения урлов уже с обычными кастомными свойствами. Исправил и закрыл. Дело за отгрузкой этого исправления в Safari.

## Тест работы путей с кастомными свойствами

То была история. А для понимания всех тонкостей текущей проблемы работы путей с кастомными свойствами легче всего разобраться с довольно простым устройством теста.

Обычное (не регистрируемое) кастомное свойство

```
--my-image: url("./foo.svg");
```

объявляется в стилевом файле в одной директории `/a/style.css`, а используется в другой `/b/style.css`. Этот вариант я назвал **Inside** — `url()` находится _внутри_ кастомного свойства:

```
background: var(--my-image);
```

Но Дарин с Вадимом пришли из бага, пример кода в котором можно назвать **Beside** — `url()` не в кастомном свойстве, а просто _рядом_, через пробел от `var()` с кастомным свойством, в котором может быть вообще любое значение, например цвет:

```
background: url("./foo.svg") var(--my-color);
```

И раз уж возможно такое, то нельзя исключать и вариант **Outside** — `var()` находится от `url()` вообще _в соседнем_ (через запятую) значении множественного значения.

```
background:
    url("./foo.svg"),
    linear-gradient(var(--my-color), var(--my-color));
```

Но и это ещё не всё. Упомянутое ранее небольшое, но существенное, отличие в коде, которое ломало разрешение пути — это всего лишь форма свойства, в значении которого применяется путь. Представленные выше варианты используют сокращённую форму свойства и все их можно назвать **Shorthand**. Для Beside возможен только такой вариант. Но остальные сценарии возможны и с отдельными (не сокращёнными) формами свойства — **Longhand**. В таком случае Inside выглядит так:

```
background-image: var(--my-image);
```

а Outside вот так:

```
background-image:
    url("./foo.svg"),
    linear-gradient(var(--my-color), var(--my-color));
```

Во всех случаях `url()` содержит путь до файла без переходов по директориям `url("./foo.svg")`. И во всех случаях он должен резолвиться в путь `/b/foo.svg`, по которому находится изображение:

<img src="./b/foo.svg" width="100" height="100" alt="Success!">

Для Inside стоило предусмотреть разрешение пути по месту объявления кастомного свойства, то есть в путь `/a/foo.svg`, поэтому там я разместил изображение:

<img src="./a/foo.svg" width="100" height="100" alt="Wrong folder">

И остаётся последний из возможных резрешений пути — рядом с файлом разметки `/foo.svg`:

<img src="./foo.svg" width="100" height="100" alt="Fail :(">

Вся стуруктура проекта выглядит так:

```
> $ tree
.
├── a
│   ├── foo.svg
│   └── style.css
├── b
│   ├── foo.svg
│   └── style.css
├── foo.svg
└── index.html
```

Проверить работу путей с кастомными свойствами в вашем браузере можно на [странице теста](https://firefoxic.github.io/test-custom-properties-working-with-url/).

<!-- <link rel="stylesheet" href="https://firefoxic.github.io/test-custom-properties-working-with-url/a/style.css">
<link rel="stylesheet" href="https://firefoxic.github.io/test-custom-properties-working-with-url/b/style.css"> -->


<!-- Или прямо тут:

<table>
    <thead>
        <tr>
            <td></td>
            <th scope="col">Inside</th>
            <th scope="col">Beside</th>
            <th scope="col">Outside</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <th scope="row">Shorthand</th>
            <td>
                <div class="test test--bg_shorthand test--url_inside"></div>
            </td>
            <td>
                <div class="test test--bg_shorthand test--url_beside"></div>
            </td>
            <td>
                <div class="test test--bg_shorthand test--url_outside"></div>
            </td>
        </tr>
        <tr>
            <th scope="row">Longhand</th>
            <td>
                <div class="test test--bg_longhand test--url_inside"></div>
            </td>
            <td></td>
            <td>
                <div class="test test--bg_longhand test--url_outside"></div>
            </td>
        </tr>
    </tbody>
</table> -->

До 14й версии в Safari все пять возможных тестов фэйлились. Начиная с 14.1 — все тесты с Shorthand стали проходить успешно (видимо это и был фикс [бага 198512](https://bugs.webkit.org/show_bug.cgi?id=198512)), но оба Longhand фэйлятся.

Напомню, что этот тест касается только обычных кастомных свойств. Если ещё не запутались в этом всём, то попробуйте угадать, в какое изображение должен резолвиться путь в каждом из сценариев, если обычное кастомное свойство заменить регистрируемым.

Думаю, если повнимательнее присмотреться например к коду сценария Longhand+Outside, то станет понятно, что разрешение пути до `/foo.svg` ну никак не может считаться нормальным поведением движка браузера. Это очевидная ошибка. Поэтому всё-таки «починили», а не «поменяли» поведение.

Остаётся лишь дождаться стабильного релиза с этой починкой и с полным _Success_ в тесте. А также надеяться, что с путями в регистрируемых кастомных свойствах будет всё хорошо. А пока…

## Заключение

Напоследок пара советов:

1. Если вам понадобится заиспользовать `url()` хотя бы где-то рядом (внутри одного свойства) с использованием кастомного свойства, и тем более `url()` внутри кастомного свойства — используйте для этого пока, до релиза фикса, сокращённые свойства `background` и `mask`, а не отдельные `background-image` и `mask-image`.
2. Не бойтесь писать об ошибках в баг-треккеры браузеров. Написал бы я сразу, а не месяцы спустя, может уже фикс был бы в стабильном релизе. И не просто ждите, когда больной для вас баг вылечат — помогите разработчикам хоть чем-нибудь, информации подробной дайте, или тест соберите (даже ошибочность релизноутов [обнаружили](https://bugs.webkit.org/show_bug.cgi?id=230243#c13), прогоняя этот мой тест).
